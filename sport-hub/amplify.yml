version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            - nvm use 20
            - node -v
            # Check environment variables before build
            - node scripts/check-env.js
            - chmod +x scripts/setup_environ.sh
            - ./scripts/setup_environ.sh
        build:
          commands:
            # Write environment variables to .env.production for Next.js SSR runtime access
            # This is the AWS Amplify recommended approach per:
            # https://docs.aws.amazon.com/amplify/latest/userguide/ssr-environment-variables.html
            - env | grep -e COGNITO_CLIENT_ID >> .env.production
            - env | grep -e COGNITO_CLIENT_SECRET >> .env.production
            - env | grep -e COGNITO_REGION >> .env.production
            - env | grep -e COGNITO_USER_POOL_ID >> .env.production
            - env | grep -e AUTH_SECRET >> .env.production
            - env | grep -e AUTH_URL >> .env.production
            - chmod +x scripts/build_sporthub.sh
            - ./scripts/build_sporthub.sh
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - .next/cache/**/*
          - node_modules/**/*
    appRoot: sport-hub
